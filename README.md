# Проект API Telegram бота

## Перечень и описание сущностей

### Пользователь

1. **ID** - Уникальный идентификатор пользователя, он же первичный ключ.
2. **Telegram ID** - Идентификатор пользователя в Telegram.
3. **Username** - Имя пользователя в Telegram.
4. **First Name** - Имя пользователя в Telegram.
5. **Last Name** - Фамилия пользователя в Telegram.
6. **Language Code** - Код языка пользователя в Telegram в формате [(ISO 639-1)](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%B4%D1%8B\_%D1%8F%D0%B7%D1%8B%D0%BA%D0%BE%D0%B2).
7. **Is Active** - Флаг активности пользователя. Полезно, если нужно временно блокировать пользователя или отмечать его активность.
8. **Created At** - Дата и время создания записи о пользователе. Пример: **`"2023-07-12T09:00:00Z"`**.
9. **Updated At** - Дата и время последнего обновления записи пользователя. Пример: **`"2023-07-12T09:00:00Z"`**.

### Транзакция

1. **ID** - Уникальный идентификатор транзакции.
2. **User ID** - Идентификатор пользователя, который совершил транзакцию.
3. **Amount** - Сумма транзакции. Значение может быть положительным или отрицательным, в зависимости от того, приходит ли деньги пользователю или уходят.
4. **Currency** - Код валюты транзакции в формате [(ISO 4217)](https://www.iban.ru/currency-codes).
5. **Description** - Описание транзакции. Может содержать информацию о том, за что была совершена транзакция.
6. **Status** - Статус транзакции (например, "pending", "completed", "failed", "refunded").
7. **Payment Method** - Способ оплаты, который использовался для транзакции (например, "credit card", "paypal").
8. **Created At** - Дата и время создания записи о транзакции. Пример: **`"2023-07-12T09:00:00Z"`**.
9. **Updated At** - Дата и время последнего обновления записи о транзакции. Пример: **`"2023-07-12T09:00:00Z"`**.

### Покупка

1. **ID**\: уникальный идентификатор покупки.
2. **User ID**\: идентификатор пользователя, осуществившего покупку. Это связывает покупку с конкретным пользователем в системе.
3. **Transaction ID**\: идентификатор транзакции, связанной с покупкой. Это позволяет связать покупку с конкретной транзакцией.
4. ~~**Item ID**\: идентификатор товара, который был куплен. Это связывает покупку с конкретным товаром в вашей системе. Поле всегда имеет значение `1` . Нужно для возможного расширения функционала. Данный атрибут передавать не нужно, он будет установлен автоматически.~~ **Поле будет скрыто в API**.
5. **Quantity**\: количество купленного товара. Это число, которое указывает, сколько единиц товара было куплено.
6. **Created At**\: дата и время создания записи о покупке. Это timestamp, который показывает, когда запись о покупке была создана в системе. Пример: **`"2023-07-12T09:00:00Z"`**.
7. **Updated At**\: дата и время последнего обновления информации о покупке. Это также timestamp, который показывает, когда информация о покупке была обновлена в последний раз. Пример: **`"2023-07-12T10:00:00Z"`**.

## Перечень функций API

1. **Пользователи**
   * Регистрация пользователя
   * Получение информации о пользователе
   * Обновление информации о пользователе
2. **Платежные транзакции**
   * Создание транзакции
   * Получение информации о транзакции
3. **История покупок**
   * Получение списка покупок пользователя
   * Создание записи о покупке после завершения транзакции

## Авторизация

Доступ к API осуществляется после успешного прохождения авторизации посредством проверки API Token, который должен быть указан в заголовке `api_token`. Токен имеет формат строки длиной в 70 символов. Пример токена: `XT80HEkFmh4dc9oOFkDGkOMOvkg8UtarDe8RElpWrPORHdRpFjuJ9edTYnNyUljylVzbsl`

## Перечень маршрутов

Ответы на запросы возвращаются в **json** формате. При создании новой сущности в качестве ответа возвращается добавленная в БД сущность.

1. ### **Пользователи**

   * **`POST /users`** - Регистрация нового пользователя. Успешный код: `201`.

     *Параметры запроса*\: **`telegram_id`**, **`username`**, **`first_name`**, **`last_name`**, **`language_code`**

     *Ответ*\: **`id`**, **`telegram_id`**, **`username`**, **`first_name`**, **`last_name`**, **`language_code`**, **`is_active`**, **`created_at`**, **`updated_at`**
   * **`GET /users/{id}`** - Получение информации о пользователе по ID. Успешный код: `200`.

     *Параметры запроса*\: Нет

     *Ответ*\: **`id`**, **`telegram_id`**, **`username`**, **`first_name`**, **`last_name`**, **`language_code`**, **`is_active`**, **`created_at`**, **`updated_at`**
   * **`PUT /users/{id}`** - Обновление информации о пользователе. Успешный код: `200`.

     *Параметры запроса*\: **`telegram_id`**, **`username`**, **`first_name`**, **`last_name`**, **`language_code`**, **`is_active`**

     *Ответ*\: **`id`**, **`telegram_id`**, **`username`**, **`first_name`**, **`last_name`**, **`language_code`**, **`is_active`**, **`created_at`**, **`updated_at`**

     *Формат ответа одинаков для всех запросов.*

     Пример ответа:

     ```json
     {
       "success": true,
       "data": {
         "id": 1,
         "telegram_id": 123456,
         "username": "john_doe",
         "first_name": "John",
         "last_name": "Doe",
         "language_code": "en",
         "is_active": true,
         "created_at": "2023-07-12T09:00:00Z",
         "updated_at": "2023-07-12T09:00:00Z"
       }
     }
     ```

2. ### **Платежные транзакции**

   * **`POST /transactions`** - Создание новой транзакции. Успешный код: `201`.

     *Параметры запроса*\: **`user_id`**, **`amount`**, **`currency`**, **`description`**, **`status`**, **`payment_method`**

     *Ответ*\: **`id`**, **`user_id`**, **`amount`**, **`currency`**, **`description`**, **`status`**, **`payment_method`**, **`created_at`**, **`updated_at`**
   * **`GET /transactions/{id}`** - Получение информации о транзакции по ID. Успешный код: `200`.

     *Параметры запроса*\: Нет

     *Ответ*\: **`id`**, **`user_id`**, **`amount`**, **`currency`**, **`description`**, **`status`**, **`payment_method`**, **`created_at`**, **`updated_at`**
   * **`GET /users/{id}/transactions`** - Получение списка транзакций пользователя. Успешный код: `200`.

     *Параметры запроса*\: Нет

     *Ответ*\: массив объектов транзакций, каждый из которых включает **`id`**, **`user_id`**, **`amount`**, **`currency`**, **`description`**, **`status`**, **`payment_method`**, **`created_at`**, **`updated_at`**

     *Формат ответа одинаков для всех запросов.*

     **Пример получения отдельной транзакции:**

     ```json
     {
       "success": true,
       "data": {
         "id": 1,
         "user_id": 1,
         "amount": 100,
         "currency": "USD",
         "description": "Payment for goods",
         "status": "completed",
         "payment_method": "credit_card",
         "created_at": "2023-07-12T10:00:00Z",
         "updated_at": "2023-07-12T10:00:00Z"
       }
     }
     ```

     **Пример получения множества транзакций:**

     ```json
     {
       "success": true,
       "data": [{
         "id": 1,
         "user_id": 1,
         "amount": 100,
         "currency": "USD",
         "description": "Payment for goods",
         "status": "completed",
         "payment_method": "credit_card",
         "created_at": "2023-07-12T10:00:00Z",
         "updated_at": "2023-07-12T10:00:00Z"
       }]
     }
     ```

3. ### **История покупок**

   * **`GET /users/{id}/purchases`** - Получение списка покупок пользователя. Успешный код: `200`.

     *Параметры запроса*\: Нет

     *Ответ*\: массив объектов покупок, каждый из которых включает **`id`**, **`user_id`**, **`transaction_id`**, **`quantity`**, **`created_at`**, **`updated_at`**
   * **`POST /users/{id}/purchases`** - Создание новой записи о покупке после завершения транзакции. Успешный код: `201`.

     *Параметры запроса*\: **`transaction_id`**, **`quantity`**

     *Ответ*\: **`purchase_id`**, **`user_id`**, **`transaction_id`**, **`quantity`**, **`created_at`**, **`updated_at`**

     *Формат ответа одинаков для всех запросов.*

     **Пример получения списка покупок:**

     ```json
     {
       "success": true,
       "data": [{
         "purchase_id": 1,
         "user_id": 1,
         "transaction_id": 1,
         "quantity": 2,
         "created_at": "2023-07-12T10:00:00Z",
         "updated_at": "2023-07-12T10:00:00Z"
       }]
     }
     ```

     **Пример получения отдельной покупки (при создании новой покупки):**

     ```json
     {
       "success": true,
       "data": {
         "purchase_id": 1,
         "user_id": 1,
         "transaction_id": 1,
         "quantity": 2,
         "created_at": "2023-07-12T10:00:00Z",
         "updated_at": "2023-07-12T10:00:00Z"
       }
     }
     ```

4. ### **Баланс**

   Для проверки баланса будет использоваться отдельный маршрут. Это сделано для экономии ресурсов, поскольку баланс рассчитывается на основе транзакций пользователя. В качестве единицы баланса используется количество оставшихся проверок. Так сделано, поскольку пользователь может пополнять счёт в разных валютах

   * **`GET /users/{id}/balance`** - Получение информации о текущем балансе пользователя. Успешный код: `200`.

     *Параметры запроса*\: Нет

     *Ответ*\: **`balance`**

     Пример ответа:

     ```json
     {
       "success": true,
       "data": {
         "balance": 300,
       }
     }
     ```

5. ### **Автомобили**

   Данный маршрут предназначен для получения и удаления данных об автомобилях.

   * **`GET /cars`** - Получение информации об автомобилях по VIN-кодам. Успешный код: `200`.
  
     *Параметры запроса*\: **`vins`**: **array**

     *Ответ*\: **`cars`**: **array** (см. пример ответа)

      **Пример успешного получения одного автомобиля:**

     ```json
     {
       "success": true,
       "data": [
          {
            "success": true,
            "vin": "1HGCM82633A123456",
            "name": "Honda Accord 2019",
          }
        ]
     }
     ```
   
     **Примечание\:** *Обратите внимание, что даже при получении одного автомобиля поле запроса **`vins`** должно быть массивом*
     
     **Примечание\:** *Обратите внимание, что даже при получении одного автомобиля, поле ответа **`data`** будет массивом объектов*

     **Пример успешного получения списка автомобилей:**

     ```json
     {
       "success": true,
       "data": [
          {
            "success": true,
            "vin": "1HGCM82633A123456",
            "name": "Honda Accord 2019",
          },
          {
            "success": true,
            "vin": "1HGCM82633A123457",
            "name": "Honda Civic 2014",
          },
          ...
        ]
     }
     ```

     **Пример получения списка автомобилей, когда один из элементов отсутсвует в базе, либо удалён ранее\:**

     ```json
     {
       "success": false,
       "data": [
          {
            "success": true,
            "vin": "1HGCM82633A123456",
            "name": "Honda Accord 2019",
          },
          {
            "success": false,
            "vin": "1HGCM82633A123457",
            "message": "Car not found",
          },
          ...
        ]
     }
     ```

     **Примечание\:** *Поле **`message`** будет локализовано, в зависимости от выбранного пользователем языка*

     **Примечание\:** *Код ответа в таком случае будет **`200`**, при этом значение поля **`success`** будет равно **`false`**. Однако, если ни один элемент не найден - код ответа будет **`404`**.*

   * **`DELETE /cars`** - Удаление автомобилей по VIN-кодам. Успешный код: `200`.
  
     *Параметры запроса*\: **`vins`**: **array**.

     **Пример ответа при успешном удалении списка автомобилей\:**

     ```json
     {
       "success": true,
       "data": [
          {
            "success": true,
            "vin": "1HGCM82633A123456",
          },
          {
            "success": true,
            "vin": "1HGCM82633A123457",
          },
          ...
        ]
     }
     ```

     **Пример ответа при частично успешном удалении списка автомобилей\:**

     ```json
     {
       "success": false,
       "data": [
          {
            "success": true,
            "vin": "1HGCM82633A123456",
          },
          {
            "success": false,
            "vin": "1HGCM82633A123457",
            "message": "Car not found",
          },
          ...
        ]
     }
     ```

     **Примечание\:** *Поле **`message`** будет локализовано, в зависимости от выбранного пользователем языка*

     **Примечание\:** *Код ответа в таком случае будет **`200`**, при этом значение поля **`success`** будет равно **`false`**. Однако, если ни один элемент не найден - код ответа будет **`404`**.*

## Ошибочные запросы

При наличии ошибок в работе алгоритма формат ответа будет следующим:

```json
{
  "success": false,
  "message": "Error message"
}
```

*Сообщение будет на языке, который использует пользователь.*



Подобный результат может возникнуть в ситуации, когда у пользователя недостаточно проверок на балансе, либо запрос от бота передан неверно.

### Коды ответов

* Неверный или отсутствующий токен: `403`
* Запрос несуществующей записи: `404`
* Создание пользователя с уже существующим `telegram_id`\: `409`
* Возможные прочие ошибки: `500`
