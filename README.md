# Проект API Telegram бота

## Перечень и описание сущностей

### Пользователь

1. **Telegram ID** - Идентификатор пользователя в Telegram.
2. **Username** - Имя пользователя в Telegram.
3. **First Name** - Имя пользователя в Telegram.
4. **Last Name** - Фамилия пользователя в Telegram.
5. **Language Code** - Код языка пользователя в Telegram в формате [(ISO 639-1)](https://ru.wikipedia.org/wiki/%D0%9A%D0%BE%D0%B4%D1%8B\_%D1%8F%D0%B7%D1%8B%D0%BA%D0%BE%D0%B2).
6. **Is Active** - Флаг активности пользователя. Полезно, если нужно временно блокировать пользователя или отмечать его активность.

### Транзакция

Транзакция создаётся при пополнении баланса пользователем.

1. **Amount** - Сумма транзакции. Значение может быть положительным или отрицательным, в зависимости от того, приходит ли деньги пользователю или уходят.
2. **Currency** - Код валюты транзакции в формате [(ISO 4217)](https://www.iban.ru/currency-codes).
3. **Description** - Описание транзакции. Может содержать информацию о том, за что была совершена транзакция.
4. **Status** - Статус транзакции (например, "pending", "completed", "failed", "refunded").
5. **Payment Method** - Способ оплаты, который использовался для транзакции (например, "credit card", "paypal").
6. **Checks** - Количество приобретённых проверок

## Перечень функций API

1. **Пользователи**

   * Регистрация пользователя
   * Получение информации о текущем пользователе
   * Обновление информации о текущем пользователе

2. **Платежные транзакции**

   * Создание транзакции
   * Получение информации о транзакции

3. **Автомобили**

   * Получение информации по переданным vin кодам
   * Удаление переданных vin кодов из базы

## Авторизация

Доступ к API осуществляется после успешного прохождения авторизации посредством проверки API Token, который должен быть указан в заголовке `Api-Token`. Токен имеет формат строки длиной в 70 символов. Пример токена: `XT80HEkFmh4dc9oOFkDGkOMOvkg8UtarDe8RElpWrPORHdRpFjuJ9edTYnNyUljylVzbsl`.

Ряд маршрутов также требуют передачу заголовка `Telegram-Id`, где будет храниться значение `telegram_id` зарегистрированного пользователя. Это необходимо в тех случаях, когда действия производятся относительно пользователя, либо затрагивают его. Такие маршруты будут обозначены как <span style="color:red;">**tg.**</span>

## <span style="color:red;"></span>Структура ответа

Все маршруты возвращают в качестве ответа JSON объект, в котором есть 2 обязательные составляющие: `success` и `data`.

* **Success** - может быть `true` или `false` в зависимости от того, был ли запрос успешен.
* **Data** - объект с данными, которые необходимо было получить. Это может быть пользователь или автомобиль.
* **Message** - данный атрибут появляется в случае, если было обращение к маршруту операции (прим. регистрация пользователя) или при выполнении запроса возникла ошибка. Содержит краткое описание результата выполнения.
* **Error** - данный атрибут появляется только в случае ошибки. Содержит более развёрнутое описание проблемы.

  *Поля* `message` *и* `error` *локализуются в зависимости от языка пользователя.*

## Локализация

При наличии полей `message` или `error` они будут локализованы согласно языку пользователя. Поддерживается 2 локали: `en` и `ru`.

При необходимости, есть возможность указать необходимую локаль в заголовке `lang`, она будет более приоритетной, чем указанная пользователем. Если в запросе не фигурирует пользователь, а локаль не указана, по умолчанию будет выбран английский вариант.

## Перечень маршрутов

Ответы на запросы возвращаются в **json** формате. При создании новой сущности в качестве ответа возвращается добавленная в БД сущность.

1. ### **Пользователи**

   * **`POST /api/users`** - Регистрация нового пользователя. Успешный код: `201`.

     *Параметры запроса*\: **`telegram_id`**, **`username`**, **`first_name`**, **`last_name`**, **`language_code`**

     *Ответ*\: **`success`**, **`message`**
   * **`GET /api/users/current`** <span style="color:red;">**\:tg**</span> - Получение информации о текущем пользователе. Успешный код: `200`.

     *Параметры запроса*\: Нет

     *Ответ*\: `success`, `data:` **`id`**, **`telegram_id`**, **`username`**, **`first_name`**, **`last_name`**, **`language_code`**, **`is_active`**, **`created_at`**, **`updated_at`**
   * **`POST /api/users/current`** <span style="color:red;">**\:tg**</span><span style="color:red;"> </span> - Обновление информации о текущем пользователе. Успешный код: `200`.

     *Параметры запроса*\: **`username`**, **`first_name`**, **`last_name`**, **`language_code`**, **`is_active`**

     *Ответ*\: **`success`**, **`message`**

     *Формат ответа одинаков для всех запросов.*

     Пример ответа получения информации о текущем пользователе:

     ```json
     {
       "success": true,
       "data": {
         "telegram_id": 123456,
         "username": "john_doe",
         "first_name": "John",
         "last_name": "Doe",
         "language_code": "en",
         "is_active": true,
         "balance": 5
       }
     }
     
     ```

     Пример неудачной попытки регистрации пользователя:

     ```json
     {
       "success": false,
       "message": "User with this id already exists"
     }
     ```

2. ### **Платежные транзакции**

   * **`POST /api/transactions`**<span style="color:red;">**\:tg**</span><span style="color:red;"> </span> - Создание новой транзакции. Успешный код: `201`.

     *Параметры запроса*\: **`user_id`**, **`amount`**, **`currency`**, **`description`**, **`status`**, **`payment_method`, `checks`**

     *Ответ*\: `success`, `message`

3. ### **Операции с автомобилями**

   * **`GET /api/cars`**<span style="color:red;">**\:tg**</span> - Получение автомобилей  Успешный код: `200`.

     *Параметры запроса*\: **`vins`** - массив vin кодов

     *Ответ*\: **`success`**, **`data:`** **`vin`**, **`name`**, **`year`**

     **Пример успешного получения списка автомобилей**

     ```json
     {
         "success": true,
         "data": [
             {
                 "vin": "WBA8E5G55GNT94124",
                 "name": "BMW 3 Series, 320I Xdrive",
                 "year": 2016
             },
             {
                 "vin": "KMHCN36C19U123745",
                 "name": "Hyundai Accent, Man Se",
                 "year": 2009
             },
             {
                 "vin": "5LMPU28A8XLJ39984",
                 "name": "Lincoln Navigator",
                 "year": 1999
             }
         ]
     }
     ```

     **Пример получения списка автомобилей, когда один из элементов отсутствует в базе, либо удалён ранее:**

     ```json
     {
        "success": false,
        "data": [
           {
             "success": true,
             "vin": "1HGCM82633A123456",
             "name": "Honda Accord",
             "year": 2019
           },
           {
             "success": false,
             "vin": "1HGCM82633A123457",
             "message": "Car not found",
           },
           ...
         ]
     }
     ```

     **Примечание:** *Код ответа в таком случае будет **`200`**, при этом значение поля **`success`** будет равно **`false`**. Однако, если ни один элемент не найден - код ответа будет **`404`**.*
   * **`DELETE /api/cars`**<span style="color:red;">**\:tg**</span><span style="color:red;"> </span> - Удаление автомобилей из базы. Успешный код: `200`.

     *Параметры запроса*\: **`vins`** - массив vin кодов

     *Ответ*\: **`success`**, \*\*`data:array:` \*\*`success`, `vin`

     **Пример ответа при успешном удалении списка автомобилей:**

     ```json
     {
       "success": true,
       "data": [
          {
            "success": true,
            "vin": "1HGCM82633A123456",
          },
          {
            "success": true,
            "vin": "1HGCM82633A123457",
          },
          ...
        ]
     }
     ```

     **Пример ответа при частично успешном удалении списка автомобилей:**

     ```json
     {
       "success": false,
       "data": [
          {
            "success": true,
            "vin": "1HGCM82633A123456",
          },
          {
            "success": false,
            "vin": "1HGCM82633A123457"
          },
          ...
        ]
     }
     ```

     **Примечание:** *Код ответа в таком случае будет **`200`**, при этом значение поля **`success`** будет равно **`false`**. Однако, если ни один элемент не найден - код ответа будет **`404`**.*

## Ошибочные запросы

При наличии ошибок в работе алгоритма формат ответа будет следующим:

```json
{
  "success": false,
  "message": "Error message",
  "error": "Full error message"
}
```

*Сообщение будет на языке, который использует пользователь.*



Подобный результат может возникнуть в ситуации, когда у пользователя недостаточно проверок на балансе, либо запрос от бота передан неверно.

### Коды ответов

* Неверный или отсутствующий токен: `403`
* Запрос несуществующей записи: `404`
* Создание пользователя с уже существующим `telegram_id`\: `409`
* Возможные прочие ошибки: `500`
